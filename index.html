<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner — فقط گالری</title>
<style>
body {
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  background: #0b1220;
  color: #fff;
}
h1 {
  margin-bottom: 20px;
}
#qr-file {
  margin-bottom: 20px;
}
#result-canvas {
  border: 2px solid #fff;
  border-radius: 8px;
  max-width: 100%;
}
</style>
</head>
<body>
<h1>QR Scanner — گالری</h1>
<input type="file" id="qr-file" accept="image/*">
<canvas id="result-canvas"></canvas>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
const fileInput = document.getElementById('qr-file');
const canvas = document.getElementById('result-canvas');
const ctx = canvas.getContext('2d');

fileInput.addEventListener('change', async (ev) => {
  const file = ev.target.files[0];
  if (!file) return;

  const dataUrl = await new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = e => res(e.target.result);
    reader.onerror = e => rej(e);
    reader.readAsDataURL(file);
  });

  const img = await new Promise((res, rej) => {
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = e => rej(e);
    i.src = dataUrl;
  });

  // تنظیم سایز کانواس
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;
  ctx.drawImage(img, 0, 0);

  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(imageData.data, canvas.width, canvas.height);

  if(code && code.data){
    // دور برش
    const margin = 10;
    const x = Math.max(code.location.topLeftCorner.x - margin,0);
    const y = Math.max(code.location.topLeftCorner.y - margin,0);
    const w = Math.min(code.location.bottomRightCorner.x - code.location.topLeftCorner.x + 2*margin, canvas.width - x);
    const h = Math.min(code.location.bottomRightCorner.y - code.location.topLeftCorner.y + 2*margin, canvas.height - y);

    const qrImageData = ctx.getImageData(x,y,w,h);
    canvas.width = w;
    canvas.height = h;
    ctx.putImageData(qrImageData,0,0);

    // اضافه کردن متن روی تصویر
    ctx.fillStyle = "#fffa";
    ctx.font = Math.floor(canvas.height/12) + "px sans-serif";
    ctx.fillText("rdnsparham-rgb.github.io/QR-Scanner", 10, canvas.height - 10);
  } else {
    alert("QR پیدا نشد یا تصویر نامعتبر است.");
  }
});
</script>
</body>
</html>
