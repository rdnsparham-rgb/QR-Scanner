<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner نهایی</title>
<style>
body{font-family:sans-serif;background:#0b1220;color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:16px}
.card{width:100%;max-width:600px;background:linear-gradient(180deg,#071028,#0b1220);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
h1{margin:0 0 12px;text-align:center;font-size:20px}
#reader{width:100%;height:360px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;overflow:hidden}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;justify-content:center}
button,input[type=file]{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;background:#e6eef8;color:#0b1220;font-weight:600}
input[type=file]{background:transparent;color:inherit;border:1px dashed rgba(230,238,248,0.12);padding:8px}
#result{margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03);word-break:break-word;min-height:56px}
.actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.tiny{padding:6px 8px;font-size:13px}
.link-btn{background:transparent;border:1px solid rgba(230,238,248,0.12);color:#a8d0ff}
canvas{display:none}
</style>
</head>
<body>
<div class="card">
  <h1>QR Scanner نهایی</h1>
  <div id="reader">ویدیو / تصویر اینجا نمایش داده می‌شود</div>
  <div class="controls">
    <input id="qr-file" type="file" accept="image/*" title="انتخاب عکس از گالری">
    <button id="start-camera">شروع اسکن با دوربین</button>
    <button id="stop-camera">توقف دوربین</button>
    <button id="clear-result" class="tiny">پاک کردن نتیجه</button>
  </div>
  <div id="result">نتیجه: —</div>
  <div class="actions" id="actions-area" style="display:none">
    <button id="open-link" class="tiny link-btn">باز کردن لینک</button>
    <button id="copy-text" class="tiny">کپی متن</button>
    <button id="show-raw" class="tiny">نمایش خام</button>
  </div>
</div>

<!-- کتابخانه‌ها -->
<script src="https://unpkg.com/html5-qrcode@2.3.12/minified/html5-qrcode.min.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<canvas id="hidden-canvas"></canvas>

<script>
const reader = document.getElementById('reader');
const fileInput = document.getElementById('qr-file');
const startBtn = document.getElementById('start-camera');
const stopBtn = document.getElementById('stop-camera');
const clearBtn = document.getElementById('clear-result');
const resultDiv = document.getElementById('result');
const actionsArea = document.getElementById('actions-area');
const openLinkBtn = document.getElementById('open-link');
const copyBtn = document.getElementById('copy-text');
const showRawBtn = document.getElementById('show-raw');
const canvas = document.getElementById('hidden-canvas');
let html5QrCode=null,lastDecoded=null;

function setResult(txt,isErr=false){
  lastDecoded=txt;
  resultDiv.textContent=(isErr?"خطا: ":"نتیجه: ")+(txt===null?'—':txt);
  actionsArea.style.display=(isErr||!txt)?"none":"flex";
  if(txt && /^(https?:\/\/)|(\w+\.\w{2,})/.test(txt)) openLinkBtn.style.display='inline-block';
  else openLinkBtn.style.display='none';
}

function ensureInstance(){
  if(typeof Html5Qrcode==='undefined'){setResult("Html5Qrcode بارگذاری نشده",true); return null;}
  if(html5QrCode) return html5QrCode;
  html5QrCode=new Html5Qrcode(reader.id,{verbose:false});
  return html5QrCode;
}

/* دوربین */
startBtn.onclick=async()=>{
  const inst=ensureInstance();
  if(!inst) return;
  try{
    await inst.start({facingMode:"environment"},{fps:10,qrbox:250},qr=>setResult(qr.decodedText||qr));
    setResult("دوربین فعال شد — منتظر QR ...");
  }catch(e){setResult("دوربین فعال نشد: "+(e.message||e),true);}
};
stopBtn.onclick=async()=>{
  if(!html5QrCode){setResult("دوربینی در حال اجرا نیست",true);return;}
  try{await html5QrCode.stop();await html5QrCode.clear();html5QrCode=null;setResult("دوربین متوقف شد");}catch(e){setResult("خطا در توقف: "+e,true);}
};

/* دکمه‌ها */
clearBtn.onclick=()=>setResult(null);
openLinkBtn.onclick=()=>{if(!lastDecoded)return;let s=lastDecoded.trim();if(!/^https?:\/\//i.test(s)) s='http://'+s;window.open(s,'_blank');};
copyBtn.onclick=async()=>{if(!lastDecoded)return;try{await navigator.clipboard.writeText(lastDecoded);alert("کپی شد");}catch(e){alert("کپی نشد");}};
showRawBtn.onclick=()=>{if(lastDecoded) alert(lastDecoded);};

/* گالری */
fileInput.onchange=async(e)=>{
  const f=e.target.files[0]; if(!f)return setResult(null,true);
  setResult("در حال پردازش...");
  try{
    const fr=new FileReader();
    fr.onload=async ev=>{
      const img=new Image();
      img.onload=()=>{
        canvas.width=img.width; canvas.height=img.height;
        const ctx=canvas.getContext("2d");
        ctx.drawImage(img,0,0);
        const code=jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data,canvas.width,canvas.height);
        if(code && code.data) setResult(code.data);
        else setResult("QR پیدا نشد یا تصویر تار است.",true);
      };
      img.src=ev.target.result;
    };
    fr.readAsDataURL(f);
  }catch(err){setResult("خطا در پردازش فایل: "+err,true);}
};

/* cleanup */
window.addEventListener('beforeunload',async()=>{try{if(html5QrCode){await html5QrCode.stop();await html5QrCode.clear();}}catch(e){}});
</script>
</body>
</html>
