<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Scanner نهایی</title>
<style>
body{margin:0;font-family:sans-serif;background:#0b1220;color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:16px}
.card{width:100%;max-width:600px;background:linear-gradient(180deg,#071028,#0b1220);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
h1{margin:0 0 12px;text-align:center;font-size:20px}
#reader{width:100%;height:360px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;overflow:hidden;position:relative}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;justify-content:center}
button,input[type=file]{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;background:#e6eef8;color:#0b1220;font-weight:600}
input[type=file]{background:transparent;color:inherit;border:1px dashed rgba(230,238,248,0.12);padding:8px}
#result{margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03);word-break:break-word;min-height:56px}
.actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.tiny{padding:6px 8px;font-size:13px}
.link-btn{background:transparent;border:1px solid rgba(230,238,248,0.12);color:#a8d0ff}
#crop-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:2px dashed #a8d0ff;width:200px;height:200px;display:none;cursor:crosshair}
#crop-tick{position:absolute;top:4px;left:4px;background:#4caf50;color:#fff;padding:2px 6px;font-weight:bold;border-radius:4px;cursor:pointer;display:none}
small{display:block;margin-top:8px;color:#99a3b5;text-align:center}
canvas{display:none}
</style>
</head>
<body>
<div class="card">
<h1>QR Scanner — نهایی</h1>
<div id="reader">ویدیو / تصویر اینجا نمایش داده می‌شود
  <div id="crop-overlay"></div>
  <div id="crop-tick">✔️</div>
</div>

<div class="controls">
<input id="qr-file" type="file" accept="image/*" title="انتخاب عکس از گالری">
<button id="start-camera">شروع اسکن با دوربین</button>
<button id="stop-camera">توقف دوربین</button>
<button id="clear-result" class="tiny">پاک کردن نتیجه</button>
</div>

<div id="result">نتیجه: —</div>

<div class="actions" id="actions-area" style="display:none">
<button id="open-link" class="tiny link-btn">باز کردن لینک</button>
<button id="copy-text" class="tiny">کپی متن</button>
<button id="show-raw" class="tiny">نمایش خام</button>
</div>

<small>در صورت مشکل، کنسول مرورگر را باز کنید (F12) و پیام‌ها را بررسی کنید.</small>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.12/minified/html5-qrcode.min.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<canvas id="hidden-canvas"></canvas>

<script>
const readerElem = document.getElementById('reader');
const fileInput = document.getElementById('qr-file');
const startBtn = document.getElementById('start-camera');
const stopBtn = document.getElementById('stop-camera');
const clearBtn = document.getElementById('clear-result');
const resultDiv = document.getElementById('result');
const actionsArea = document.getElementById('actions-area');
const openLinkBtn = document.getElementById('open-link');
const copyBtn = document.getElementById('copy-text');
const showRawBtn = document.getElementById('show-raw');
const hiddenCanvas = document.getElementById('hidden-canvas');
const cropOverlay = document.getElementById('crop-overlay');
const cropTick = document.getElementById('crop-tick');

let html5QrCode = null;
let lastDecoded = null;
let cropRect = null;

function setResultText(text,isError=false){
  lastDecoded=text;
  resultDiv.textContent=(isError?"خطا: ":"نتیجه: ")+(text===null?'—':String(text));
  if(!isError && text!==null && String(text).trim()!==''){
    actionsArea.style.display='flex';
    if(/^(https?:\/\/)/i.test(String(text).trim())) openLinkBtn.style.display='inline-block';
    else openLinkBtn.style.display='none';
  }else actionsArea.style.display='none';
}

/* CAMERA */
function ensureInstance(){
  if(html5QrCode) return html5QrCode;
  html5QrCode = new Html5Qrcode(readerElem.id,{verbose:false});
  return html5QrCode;
}

startBtn.addEventListener('click',async ()=>{
  try{
    const inst = ensureInstance();
    await inst.start({facingMode:"environment"},{fps:10,qrbox:250}, qrMessage=>{
      if(typeof qrMessage==='object' && qrMessage.decodedText) setResultText(qrMessage.decodedText);
      else setResultText(qrMessage);
    });
    setResultText("دوربین فعال شد — منتظر QR ...");
  }catch(err){
    setResultText("دوربین فعال نشد: "+(err.message||err),true);
    console.error(err);
  }
});

stopBtn.addEventListener('click',async ()=>{
  if(!html5QrCode){setResultText("دوربینی در حال اجرا نیست",true);return;}
  try{
    await html5QrCode.stop();
    await html5QrCode.clear();
    html5QrCode=null;
    setResultText("دوربین متوقف شد");
  }catch(err){
    setResultText("خطا در توقف دوربین: "+err,true);
    console.error(err);
  }
});

/* ACTION BUTTONS */
clearBtn.addEventListener('click',()=>{setResultText(null);});
openLinkBtn.addEventListener('click',()=>{if(!lastDecoded)return;let s=String(lastDecoded).trim();if(!/^(https?:\/\/)/i.test(s)) s='http://'+s;window.open(s,'_blank');});
copyBtn.addEventListener('click',async ()=>{if(!lastDecoded)return;try{await navigator.clipboard.writeText(String(lastDecoded));alert('متن کپی شد');}catch(e){alert('کپی نشد');}});
showRawBtn.addEventListener('click',()=>{if(lastDecoded) alert(String(lastDecoded));});

/* FILE */
fileInput.addEventListener('change',async (ev)=>{
  const f=ev.target.files&&ev.target.files[0];
  if(!f) return;
  setResultText("در حال پردازش تصویر...");
  try{
    const dataUrl=await fileToDataUrl(f);
    const img=await loadImage(dataUrl);
    // برش (اگر کاربر فعال کرد)
    const croppedCanvas = document.createElement('canvas');
    const ctx=croppedCanvas.getContext('2d');
    let sx=0,sy=0,sw=img.naturalWidth,sh=img.naturalHeight;
    if(cropRect){sx=cropRect.x; sy=cropRect.y; sw=cropRect.w; sh=cropRect.h;}
    croppedCanvas.width=sw; croppedCanvas.height=sh;
    ctx.drawImage(img,sx,sy,sw,sh,0,0,sw,sh);
    const code=tryJsQrDecode(croppedCanvas,sw,sh);
    if(code) { setResultText(code); return; }
    setResultText("QR پیدا نشد یا تصویر نامناسب است.",true);
  }catch(err){setResultText("خطا: "+err,true);}
});

/* HELPER FUNCTIONS */
function fileToDataUrl(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=e=>rej(e);r.readAsDataURL(file);});}
function loadImage(dataUrl){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>res(img);img.onerror=e=>rej(e);img.src=dataUrl;});}
function tryJsQrDecode(canvas,w,h){
  try{
    const ctx=canvas.getContext('2d');
    const imageData=ctx.getImageData(0,0,w,h);
    const code=jsQR(imageData.data,imageData.width,imageData.height);
    if(code&&code.data){return code.data;}
    return null;
  }catch(e){console.error(e);return null;}
}

/* CROP LOGIC */
let isDragging=false,startX=0,startY=0;
readerElem.addEventListener('mousedown',e=>{
  isDragging=true;
  startX=e.offsetX; startY=e.offsetY;
  cropOverlay.style.display='block';
  cropOverlay.style.width='0px'; cropOverlay.style.height='0px';
});
readerElem.addEventListener('mousemove',e=>{
  if(!isDragging) return;
  const w=Math.abs(e.offsetX-startX);
  const h=Math.abs(e.offsetY-startY);
  cropOverlay.style.left=startX+'px';
  cropOverlay.style.top=startY+'px';
  cropOverlay.style.width=w+'px';
  cropOverlay.style.height=h+'px';
});
readerElem.addEventListener('mouseup',e=>{
  if(!isDragging) return;
  isDragging=false;
  cropTick.style.display='block';
  cropRect={x:parseInt(cropOverlay.style.left),y:parseInt(cropOverlay.style.top),w:parseInt(cropOverlay.style.width),h:parseInt(cropOverlay.style.height)};
});
cropTick.addEventListener('click',()=>{cropOverlay.style.display='none';cropTick.style.display='none';alert('برش تایید شد! هنگام انتخاب گالری استفاده خواهد شد.');});

/* CLEANUP */
window.addEventListener('beforeunload',async ()=>{try{if(html5QrCode){await html5QrCode.stop();await html5QrCode.clear();}}catch(e){}});
</script>
</body>
</html>
