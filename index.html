<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Scanner نهایی</title>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
  }
  h1 { margin-bottom: 20px; text-align: center; }
  #reader { width: 100%; max-width: 400px; margin-bottom: 20px; background: #000; border-radius: 8px; display:flex; justify-content:center; align-items:center; color:#999; height:300px; }
  input[type="file"] { margin-bottom: 15px; }
  button { padding: 10px 15px; margin: 5px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; background:#fff; color:#333; }
  button:hover { background:#ddd; }
  #result { padding:10px; background: rgba(0,0,0,0.2); border-radius:8px; word-break: break-word; min-height:40px; margin-top:10px; width:100%; text-align:center; }
</style>
</head>
<body>
<h1>QR Scanner نهایی</h1>

<div id="reader">ویدیو / تصویر اینجا نمایش داده می‌شود</div>

<input type="file" id="qr-file" accept="image/*">
<button id="start-camera">شروع اسکن با دوربین</button>
<button id="stop-camera">توقف دوربین</button>

<div id="result">نتیجه QR اینجا نمایش داده می‌شود</div>

<script src="https://unpkg.com/html5-qrcode@2.3.12/minified/html5-qrcode.min.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<canvas id="hidden-canvas" style="display:none"></canvas>

<script>
window.onload = function() {
  const readerElem = document.getElementById('reader');
  const qrFileInput = document.getElementById('qr-file');
  const startCameraBtn = document.getElementById('start-camera');
  const stopCameraBtn = document.getElementById('stop-camera');
  const resultDiv = document.getElementById('result');
  const hiddenCanvas = document.getElementById('hidden-canvas');
  let html5QrCode = null;
  let lastDecoded = null;

  function setResult(text) {
    lastDecoded = text;
    resultDiv.textContent = "نتیجه: " + (text || "—");
  }

  function ensureHtml5Instance() {
    if (!html5QrCode) html5QrCode = new Html5Qrcode(readerElem.id);
    return html5QrCode;
  }

  // شروع دوربین
  startCameraBtn.addEventListener('click', async () => {
    try {
      const inst = ensureHtml5Instance();
      await inst.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrMsg => {
          setResult(qrMsg);
          // توقف خودکار بعد از 400ms
          setTimeout(async () => {
            try { await inst.stop(); inst.clear(); html5QrCode = null; } catch(e){console.error(e);}
          }, 400);
        }
      );
    } catch(err) {
      setResult("دوربین فعال نشد یا اجازه دسترسی داده نشده.");
      console.error(err);
    }
  });

  // توقف دستی
  stopCameraBtn.addEventListener('click', async () => {
    if (html5QrCode) {
      try { await html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; setResult("دوربین متوقف شد"); } 
      catch(e){ console.error(e); setResult("خطا در توقف دوربین"); }
    }
  });

  // اسکن گالری
  qrFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setResult("در حال پردازش تصویر...");
    try {
      const reader = new FileReader();
      reader.onload = async function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = hiddenCanvas;
          const ctx = canvas.getContext('2d');
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img,0,0);
          const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if(code && code.data) setResult(code.data);
          else setResult("QR پیدا نشد یا تصویر نامعتبر است.");
        }
        img.src = event.target.result;
      }
      reader.readAsDataURL(file);
    } catch(err) { setResult("خطا هنگام پردازش تصویر"); console.error(err);}
  });
};
</script>
</body>
</html>
