<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Scanner نهایی</title>
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
<style>
body{margin:0;font-family:sans-serif;background:#0b1220;color:#e6eef8;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:16px}
.card{width:100%;max-width:600px;background:linear-gradient(180deg,#071028,#0b1220);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
h1{text-align:center;margin-bottom:12px;font-size:20px}
#reader{width:100%;height:360px;background:#000;border-radius:8px;display:flex;justify-content:center;align-items:center;color:#999;overflow:hidden;position:relative}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;justify-content:center}
button,input[type=file]{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;background:#e6eef8;color:#0b1220;font-weight:600}
input[type=file]{background:transparent;color:inherit;border:1px dashed rgba(230,238,248,0.12);padding:8px}
#result{margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03);word-break:break-word;min-height:56px}
.actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
.tiny{padding:6px 8px;font-size:13px}
.link-btn{background:transparent;border:1px solid rgba(230,238,248,0.12);color:#a8d0ff}
small{display:block;margin-top:8px;color:#99a3b5;text-align:center}
#crop-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:9999;flex-direction:column}
#crop-image{max-width:90%;max-height:70%}
#crop-confirm{position:absolute;top:16px;left:16px;font-size:28px;color:#0f0;background:rgba(0,0,0,0.4);border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
<div class="card">
<h1>QR Scanner — نهایی</h1>
<div id="reader">ویدیو / تصویر اینجا نمایش داده می‌شود</div>
<div class="controls">
<input id="qr-file" type="file" accept="image/*">
<button id="start-camera">شروع اسکن با دوربین</button>
<button id="stop-camera">توقف دوربین</button>
<button id="clear-result" class="tiny">پاک کردن نتیجه</button>
</div>
<div id="result">نتیجه: —</div>
<div class="actions" id="actions-area" style="display:none">
<button id="open-link" class="tiny link-btn">باز کردن لینک</button>
<button id="copy-text" class="tiny">کپی متن</button>
<button id="show-raw" class="tiny">نمایش خام</button>
</div>
<small>در صورت مشکل، کنسول مرورگر را باز کنید</small>
<div id="crop-modal">
<img id="crop-image"/>
<button id="crop-confirm">✔️</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.12/minified/html5-qrcode.min.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

<script>
const reader=document.getElementById('reader');
const fileInput=document.getElementById('qr-file');
const startBtn=document.getElementById('start-camera');
const stopBtn=document.getElementById('stop-camera');
const clearBtn=document.getElementById('clear-result');
const resultDiv=document.getElementById('result');
const actionsArea=document.getElementById('actions-area');
const openLinkBtn=document.getElementById('open-link');
const copyBtn=document.getElementById('copy-text');
const showRawBtn=document.getElementById('show-raw');
const hiddenCanvas=document.createElement('canvas');
const cropModal=document.getElementById('crop-modal');
const cropImage=document.getElementById('crop-image');
const cropConfirm=document.getElementById('crop-confirm');

let cropper=null,html5QrCode=null,lastDecoded=null;

function setResult(txt,isErr=false){
lastDecoded=txt;
resultDiv.textContent=(isErr?"خطا: ":"نتیجه: ")+(txt||'—');
if(!isErr && txt){actionsArea.style.display='flex';
if(/^(https?:\/\/)/i.test(txt)||/^[\w-]+\.[\w-]{2,}/.test(txt)) openLinkBtn.style.display='inline-block';
else openLinkBtn.style.display='none';} else actionsArea.style.display='none';
}

function ensureQr(){if(html5QrCode)return html5QrCode;html5QrCode=new Html5Qrcode(reader.id,{verbose:false});return html5QrCode;}

/* CAMERA */
startBtn.onclick=async()=>{
try{
const inst=ensureQr();
await inst.start({facingMode:"environment"},{fps:10,qrbox:{width:300,height:300}}, msg=>setResult(msg.data||msg));
setResult('دوربین فعال شد — منتظر QR ...');
}catch(e){setResult('دوربین فعال نشد: '+(e.message||e),true);}
};
stopBtn.onclick=async()=>{try{if(!html5QrCode) return setResult('دوربینی در حال اجرا نیست',true); await html5QrCode.stop();await html5QrCode.clear();html5QrCode=null; setResult('دوربین متوقف شد');}catch(e){setResult('خطا در توقف دوربین: '+e,true);}};
clearBtn.onclick=()=>setResult(null);
openLinkBtn.onclick=()=>{if(!lastDecoded)return;let s=lastDecoded.trim();if(!/^(https?:\/\/)/i.test(s)) s='http://'+s;window.open(s,'_blank');};
copyBtn.onclick=async()=>{if(!lastDecoded)return;try{await navigator.clipboard.writeText(lastDecoded);alert('متن کپی شد');}catch(e){alert('کپی نشد');}};
showRawBtn.onclick=()=>{if(lastDecoded) alert(lastDecoded);};

/* FILE + Cropper */
fileInput.onchange=ev=>{const f=ev.target.files[0];if(!f) return; cropImage.src=URL.createObjectURL(f); cropModal.style.display='flex'; if(cropper) cropper.destroy(); cropper=new Cropper(cropImage,{viewMode:1,autoCropArea:1,background:false,responsive:true});};
cropConfirm.onclick=()=>{if(!cropper) return; const canvas=cropper.getCroppedCanvas(); cropModal.style.display='none'; cropper.destroy(); cropper=null; const img=new Image(); img.onload=()=>scanImg(img); img.src=canvas.toDataURL();};

function scanImg(img){setResult('در حال پردازش تصویر...'); try{const code=jsQRCanvas(img); if(code) {setResult(code);return;} setResult('QR پیدا نشد یا تصویر مشکل دارد',true);}catch(e){setResult('خطا هنگام پردازش تصویر: '+e,true);}}
function jsQRCanvas(img){const canvas=hiddenCanvas;const ctx=canvas.getContext('2d');canvas.width=img.naturalWidth||img.width; canvas.height=img.naturalHeight||img.height; ctx.drawImage(img,0,0,canvas.width,canvas.height); const data=ctx.getImageData(0,0,canvas.width,canvas.height); const code=jsQR(data.data,data.width,data.height); return code?code.data:null;}

/* cleanup */
window.addEventListener('beforeunload',async ()=>{try{if(html5QrCode){await html5QrCode.stop();await html5QrCode.clear();}}catch(e){}});
</script>
</body>
</html>
