<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QR Scanner — قوی‌تر (متن + لینک)</title>
<style>
  body{font-family:sans-serif;background:#0b1220;color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:16px}
  .card{width:100%;max-width:560px;background:linear-gradient(180deg,#071028,#0b1220);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  h1{margin:0 0 12px;text-align:center;font-size:20px}
  #reader{width:100%;height:320px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;overflow:hidden}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;justify-content:center}
  button,input[type=file]{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;background:#e6eef8;color:#0b1220;font-weight:600}
  input[type=file]{background:transparent;color:inherit;border:1px dashed rgba(230,238,248,0.12);padding:8px}
  #result{margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03);word-break:break-word;min-height:56px}
  .actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .tiny{padding:6px 8px;font-size:13px}
  .link-btn{background:transparent;border:1px solid rgba(230,238,248,0.12);color:#a8d0ff}
  small{display:block;margin-top:8px;color:#99a3b5;text-align:center}
  canvas{display:none}
</style>
</head>
<body>
<div class="card">
  <h1>QR Scanner — خواندن متن و لینک</h1>

  <div id="reader">ویدیو / تصویر اینجا نمایش داده می‌شود</div>

  <div class="controls">
    <input id="qr-file" type="file" accept="image/*" title="انتخاب عکس از گالری">
    <button id="start-camera">شروع اسکن با دوربین</button>
    <button id="stop-camera">توقف دوربین</button>
    <button id="clear-result" class="tiny">پاک کردن نتیجه</button>
  </div>

  <div id="result">نتیجه: —</div>

  <div class="actions" id="actions-area" style="display:none">
    <button id="open-link" class="tiny link-btn">باز کردن لینک</button>
    <button id="copy-text" class="tiny">کپی متن</button>
    <button id="show-raw" class="tiny">نمایش خام</button>
  </div>

  <small>اگر متن نمایش داده نشد یا پیغام خطا اومد، کنسول (DevTools) رو باز کن و لاگ‌ها رو کپی کن.</small>
</div>

<!-- کتابخانه‌ها -->
<script src="https://unpkg.com/html5-qrcode@2.3.12/minified/html5-qrcode.min.js"></script>
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<!-- یک canvas مخفی برای فالبک jsQR -->
<canvas id="hidden-canvas"></canvas>

<script>
  const readerElem = document.getElementById('reader');
  const fileInput = document.getElementById('qr-file');
  const startBtn = document.getElementById('start-camera');
  const stopBtn = document.getElementById('stop-camera');
  const clearBtn = document.getElementById('clear-result');
  const resultDiv = document.getElementById('result');
  const actionsArea = document.getElementById('actions-area');
  const openLinkBtn = document.getElementById('open-link');
  const copyBtn = document.getElementById('copy-text');
  const showRawBtn = document.getElementById('show-raw');
  const hiddenCanvas = document.getElementById('hidden-canvas');

  let html5QrCode = null;
  let isCameraRunning = false;
  let lastDecoded = null; // می‌تونه string یا object باشه

  function setResultText(text, isError=false){
    lastDecoded = text;
    resultDiv.textContent = (isError ? "خطا: " : "نتیجه: ") + (text === null ? '—' : String(text));
    console.log(isError ? "[ERROR]" : "[INFO]", text);
    // نمایش دکمه‌های عملیاتی اگر متن معتبره
    if (!isError && text !== null && String(text).trim() !== '') {
      actionsArea.style.display = 'flex';
      // اگر URL بود، دکمه باز کردن لینک فعال میشه
      if (isProbablyUrl(String(text).trim())) {
        openLinkBtn.style.display = 'inline-block';
      } else {
        openLinkBtn.style.display = 'none';
      }
    } else {
      actionsArea.style.display = 'none';
    }
  }

  function isProbablyUrl(s){
    try {
      // اگر با http/https شروع شد یا شبیه دامنه باشه
      return /^(https?:\/\/)/i.test(s) || /^[\w-]+\.[\w-]{2,}/.test(s);
    } catch(e){ return false; }
  }

  function ensureInstance(){
    if (html5QrCode) return html5QrCode;
    html5QrCode = new Html5Qrcode(readerElem.id, { verbose: false });
    return html5QrCode;
  }

  // دوربین
  startBtn.addEventListener('click', async () => {
    try {
      const inst = ensureInstance();
      await inst.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrMessage => {
          // بعضی نسخه‌ها qrMessage ممکنه رشته باشه یا شیء
          if (typeof qrMessage === 'object' && qrMessage.decodedText) {
            setResultText(qrMessage.decodedText);
          } else {
            setResultText(qrMessage);
          }
        }
      );
      isCameraRunning = true;
      setResultText("دوربین فعال شد — منتظر QR ...");
    } catch (err) {
      setResultText("دوربین فعال نشد: " + (err && err.message ? err.message : err), true);
      console.error("start error:", err);
    }
  });

  // توقف
  stopBtn.addEventListener('click', async () => {
    if (!html5QrCode) {
      setResultText("دوربینی در حال اجرا نیست", true);
      return;
    }
    try {
      await html5QrCode.stop();
      await html5QrCode.clear();
      html5QrCode = null;
      isCameraRunning = false;
      setResultText("دوربین متوقف شد");
    } catch (err) {
      setResultText("خطا در توقف دوربین: " + err, true);
      console.error("stop error:", err);
    }
  });

  // پاک کردن نتیجه
  clearBtn.addEventListener('click', () => {
    setResultText(null);
  });

  // باز کردن لینک (اگر URL باشه)
  openLinkBtn.addEventListener('click', () => {
    if (!lastDecoded) return;
    const s = String(lastDecoded).trim();
    let url = s;
    if (!/^(https?:\/\/)/i.test(url)) url = 'http://' + url;
    window.open(url, '_blank');
  });

  // کپی متن
  copyBtn.addEventListener('click', async () => {
    if (!lastDecoded) return;
    try {
      await navigator.clipboard.writeText(String(lastDecoded));
      alert('متن کپی شد');
    } catch (e) {
      alert('کپی نشد — ممکن است مرورگر اجازه ندهد');
    }
  });

  // نمایش خام (برای دیباگ)
  showRawBtn.addEventListener('click', () => {
    if (!lastDecoded) return alert(String(lastDecoded));
  });

  // اسکن فایل: ابتدا تلاش می‌کنیم با html5-qrcode، سپس fallback به jsQR
  fileInput.addEventListener('change', async (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    setResultText("در حال پردازش تصویر...");
    try {
      const inst = ensureInstance();

      // بعضی نسخه‌ها scanFileV2 برمی‌گرداند شیء {decodedText,...}
      if (typeof inst.scanFileV2 === 'function') {
        try {
          const res = await inst.scanFileV2(f, true);
          // res ممکنه شیء یا رشته باشه
          if (res && (res.decodedText || typeof res === 'string')) {
            const txt = res.decodedText ? res.decodedText : res;
            setResultText(txt);
            return;
          }
        } catch (e) {
          console.warn('scanFileV2 failed:', e);
        }
      }

      // fallback به scanFile
      if (typeof inst.scanFile === 'function') {
        try {
          const res2 = await inst.scanFile(f, true);
          if (res2) { setResultText(res2); return; }
        } catch (e) {
          console.warn('scanFile failed:', e);
        }
      }

      // آخرین فالبک: jsQR (پردازش تصویر با canvas)
      const dataUrl = await fileToDataUrl(f);
      const img = await loadImage(dataUrl);
      const detection = tryJsQrDecode(img);
      if (detection) {
        setResultText(detection);
        return;
      } else {
        setResultText("QR پیدا نشد یا تصویر خیلی تار است.", true);
        console.error("All methods failed. jsQR result null.");
      }

    } catch (err) {
      setResultText("خطا هنگام اسکن فایل: " + err, true);
      console.error("file scan error:", err);
    }
  });

  // تبدیل فایل به DataURL
  function fileToDataUrl(file){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = e => res(e.target.result);
      r.onerror = e => rej(e);
      r.readAsDataURL(file);
    });
  }

  function loadImage(dataUrl){
    return new Promise((res, rej) => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = e => rej(e);
      img.src = dataUrl;
      // اگر تصویربرداری از موبایل ممکنه لازم باشه crossOrigin
    });
  }

  function tryJsQrDecode(img){
    try {
      const canvas = hiddenCanvas;
      const ctx = canvas.getContext('2d');
      // اندازه canvas رو مطابق تصویر بذار
      const maxDim = 1000; // برای کاهش حافظه اگر تصویر خیلی بزرگه
      let w = img.naturalWidth;
      let h = img.naturalHeight;
      if (w > maxDim || h > maxDim) {
        const scale = Math.min(maxDim / w, maxDim / h);
        w = Math.floor(w * scale);
        h = Math.floor(h * scale);
      }
      canvas.width = w;
      canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      const imageData = ctx.getImageData(0, 0, w, h);
      // jsQR expects Uint8ClampedArray
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code && code.data) {
        console.log('jsQR success:', code);
        return code.data;
      }
      return null;
    } catch (e) {
      console.error('jsQR error:', e);
      return null;
    }
  }

  // در unload صفحه تلاش برای پاکسازی
  window.addEventListener('beforeunload', async () => {
    try {
      if (html5QrCode) { await html5QrCode.stop(); await html5QrCode.clear(); }
    } catch(e){}
  });

  // اگر خواستی می‌تونم یک دکمه اضافه کنم که نتیجه رو به صورت History ذخیره کنه
</script>
</body>
</html>
